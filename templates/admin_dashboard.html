<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - MovesLocation</title>
  <link rel="stylesheet" href="/static/css/style.css">
  <style>
    /* Estilo básico para acordeón */
    .user-documents { display: none; margin-top: 10px; }
    .user-name-btn { 
      background: none; 
      border: none; 
      color: #007BFF; 
      font-size: 1rem; 
      cursor: pointer; 
      text-decoration: underline; 
    }
    .user-name-btn:hover { color: #0056b3; }
    .status-badge { padding: 3px 6px; border-radius: 4px; color: white; font-weight: bold; }
    .status-badge.approved { background-color: #28a745; }
    .status-badge.pending { background-color: #ffc107; color: black; }
    .status-badge.rejected { background-color: #dc3545; }
    .admin-table { width: 100%; border-collapse: collapse; margin-top: 5px; }
    .admin-table th, .admin-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    .admin-table th { background-color: #f2f2f2; }
    .user-card { margin-bottom: 20px; padding: 10px; border: 1px solid #ccc; border-radius: 6px; }
  </style>
</head>
<body class="admin-dashboard">

<header>
  <h1>Panel de Administración</h1>
  <a href="/logout">Cerrar sesión</a>
</header>

<main>
  <!-- CLIENTES RECIENTES -->
  <section id="clientes">
    <h2>Últimos Clientes Registrados</h2>
    <table class="admin-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Nombre</th>
          <th>Email</th>
          <th>País</th>
        </tr>
      </thead>
      <tbody>
        {% for c in clientes %}
        <tr>
          <td>{{ c.id }}</td>
          <td>{{ c.first_name }} {{ c.last_name }}</td>
          <td>{{ c.email }}</td>
          <td>{{ c.country or 'N/A' }}</td>
        </tr>
        {% else %}
        <tr><td colspan="4">No hay clientes registrados</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </section>

  <!-- PROCESOS -->
  <section id="admin-processes">
    <h2>Procesos de Clientes</h2>
    <table class="admin-table">
      <thead>
        <tr>
          <th>Cliente</th>
          <th>Estado</th>
          <th>Última Actualización</th>
          <th>Acción</th>
        </tr>
      </thead>
      <tbody>
        {% for p in procesos %}
        <tr>
          <td>{{ p.first_name }} {{ p.last_name }}</td>
          <td>{{ p.status }}</td>
          <td>{{ p.updated_at.strftime('%d/%m/%Y') if p.updated_at else 'N/A' }}</td>
          <td>
            <form action="/admin/process/{{ p.id }}/status" method="POST">
              <select name="status">
                <option value="pending" {% if p.status=='pending' %}selected{% endif %}>Pendiente</option>
                <option value="in_review" {% if p.status=='in_review' %}selected{% endif %}>En Revisión</option>
                <option value="completed" {% if p.status=='completed' %}selected{% endif %}>Completado</option>
              </select>
              <button type="submit">Actualizar</button>
            </form>
          </td>
        </tr>
        {% else %}
        <tr><td colspan="4">No hay procesos registrados</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </section>

  <!-- DOCUMENTOS POR USUARIO -->
  <section id="admin-documents" class="admin-section">
    <div class="section-header">
      <h2>Documentos de Usuarios</h2>
    </div>

    {% for cliente in clientes %}
    <div class="user-card">
      <!-- Nombre clicable del usuario -->
      <button class="user-name-btn" onclick="toggleDocuments('docs-{{ cliente.id }}')">
        {{ cliente.first_name }} {{ cliente.last_name }}
      </button>

      <!-- Documentos del usuario -->
      <div class="user-documents" id="docs-{{ cliente.id }}">
        {% set user_docs = documentos_por_usuario[cliente.id] %}
        {% if user_docs %}
        <table class="admin-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Tipo de Documento</th>
              <th>Archivo</th>
              <th>Subido el</th>
              <th>Estado</th>
              <th>Acción</th>
            </tr>
          </thead>
          <tbody>
            {% for doc in user_docs %}
            <tr>
              <td>{{ doc.id }}</td>
              <td>{{ doc.type_name }}</td>
              <td><a href="{{ url_for('uploaded_file', filename=doc.file_path) }}" target="_blank">Ver Documento</a></td>
              <td>{{ doc.uploaded_at.strftime('%d/%m/%Y %H:%M') if doc.uploaded_at else 'N/A' }}</td>
              <td>
                {% if doc.status == 'approved' %}
                  <span class="status-badge approved">Aprobado</span>
                {% elif doc.status == 'pending' %}
                  <span class="status-badge pending">En Revisión</span>
                {% else %}
                  <span class="status-badge rejected">{{ doc.status }}</span>
                {% endif %}
              </td>
              <td>
                <form method="POST" action="{{ url_for('change_document_status', id=doc.id) }}">
                  <select name="status" required>
                    <option value="pending" {% if doc.status=='pending' %}selected{% endif %}>En Revisión</option>
                    <option value="approved" {% if doc.status=='approved' %}selected{% endif %}>Aprobado</option>
                    <option value="rejected" {% if doc.status=='rejected' %}selected{% endif %}>Rechazado</option>
                  </select>
                  <button type="submit">Actualizar</button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
        <p>No hay documentos subidos por este usuario.</p>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  </section>

</main>

<script>
  function toggleDocuments(id) {
    const el = document.getElementById(id);
    if (el.style.display === "block") {
      el.style.display = "none";
    } else {
      el.style.display = "block";
    }
  }
</script>

</body>
</html>
