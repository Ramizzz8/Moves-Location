<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - MovesLocation</title>
  <link rel="stylesheet" href__="/static/css/style.css">
  <link rel="preconnect" href__="https://fonts.googleapis.com">
  <link rel="preconnect" href__="https://fonts.gstatic.com" crossorigin>
  <link href__="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
</head>
<body class="light-mode admin-page">
  
  <!-- Sidebar de Administraci√≥n -->
  <aside class="admin-sidebar">
    <div class="sidebar-header">
      <a href__="/" class="logo">
        <img src="/static/images/logo.png" alt="MovesLocation">
      </a>
    </div>
    <nav class="sidebar-nav">
      <a href__="#clientes" class="nav-item active" data-section="clientes">
        <span class="nav-icon">üë•</span>
        <span class="nav-text">Clientes</span>
      </a>
      <a href__="#admin-processes" class="nav-item" data-section="admin-processes">
        <span class="nav-icon">üîÑ</span>
        <span class="nav-text">Procesos</span>
      </a>
      <a href__="#admin-documents" class="nav-item" data-section="admin-documents">
        <span class="nav-icon">üìÇ</span>
        <span class="nav-text">Documentos</span>
      </a>
    </nav>
    <div class="sidebar-footer">
      <a href__="/logout" class="liquid-button outline full-width">
        <span>Cerrar Sesi√≥n</span>
      </a>
    </div>
  </aside>

  <main class="admin-main">
    <!-- Barra Superior Mejorada -->
    <header class="admin-top-bar">
      <div class="search-bar">
        <input type="text" placeholder="Buscar cliente o tr√°mite...">
      </div>
      
      <div class="admin-actions">
        <div class="theme-switch-wrapper">
          <label class="theme-switch">
            <input type="checkbox" id="theme-toggle">
            <span class="slider">
              <span class="icon sun">‚òÄÔ∏è</span>
              <span class="icon moon">üåô</span>
            </span>
          </label>
        </div>
        
        <div class="admin-profile">
          <div class="admin-info">
            <span class="admin-name">Admin {{ current_user.first_name if current_user else 'Muvini' }}</span>
            <span class="admin-role">Data Analytics</span>
          </div>
          <div class="avatar">M</div>
        </div>
      </div>
    </header>

    <!-- CLIENTES RECIENTES -->
    <section id="clientes" class="admin-section">
      <div class="section-header">
        <h1>√öltimos Clientes Registrados</h1>
      </div>
      <div class="admin-card table-card">
        <table class="admin-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Nombre</th>
              <th>Email</th>
              <th>Pa√≠s</th>
            </tr>
          </thead>
          <tbody>
            {% for c in clientes %}
            <tr>
              <td>{{ c.id }}</td>
              <td><strong>{{ c.first_name }} {{ c.last_name }}</strong></td>
              <td>{{ c.email }}</td>
              <td><span class="country-tag">{{ c.country or 'N/A' }}</span></td>
            </tr>
            {% else %}
            <tr><td colspan="4" class="empty-msg">No hay clientes registrados</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>

    <!-- PROCESOS -->
    <section id="admin-processes" class="admin-section hidden">
      <div class="section-header">
        <h2>Procesos de Clientes</h2>
      </div>
      <div class="admin-card table-card">
        <table class="admin-table">
          <thead>
            <tr>
              <th>Cliente</th>
              <th>Estado</th>
              <th>Actualizaci√≥n</th>
              <th>Acci√≥n</th>
            </tr>
          </thead>
          <tbody>
            {% for p in procesos %}
            <tr>
              <td>{{ p.first_name }} {{ p.last_name }}</td>
              <td>
                <span class="status-badge {{ p.status }}">
                  {{ 'Pendiente' if p.status == 'pending' else 'Revisi√≥n' if p.status == 'in_review' else 'Completado' }}
                </span>
              </td>
              <td>{{ p.updated_at.strftime('%d/%m/%Y') if p.updated_at else 'N/A' }}</td>
              <td>
                <form action="/admin/process/{{ p.id }}/status" method="POST" class="inline-form">
                  <select name="status" class="admin-select">
                    <option value="pending" {% if p.status=='pending' %}selected{% endif %}>Pendiente</option>
                    <option value="in_review" {% if p.status=='in_review' %}selected{% endif %}>En Revisi√≥n</option>
                    <option value="completed" {% if p.status=='completed' %}selected{% endif %}>Completado</option>
                  </select>
                  <button type="submit" class="action-btn mini">Actualizar</button>
                </form>
              </td>
            </tr>
            {% else %}
            <tr><td colspan="4" class="empty-msg">No hay procesos registrados</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>

    <!-- DOCUMENTOS POR USUARIO -->
    <section id="admin-documents" class="admin-section hidden">
      <div class="section-header">
        <h2>Documentos de Usuarios</h2>
      </div>

      {% for cliente in clientes %}
      <div class="user-accordion-card">
        <button class="user-accordion-header" onclick="toggleDocuments(this, 'docs-{{ cliente.id }}')">
          <span class="user-info">üë§ {{ cliente.first_name }} {{ cliente.last_name }}</span>
          <span class="arrow">‚ñº</span>
        </button>

        <div class="user-documents-content hidden" id="docs-{{ cliente.id }}">
          {% set user_docs = documentos_por_usuario[cliente.id] %}
          {% if user_docs %}
          <table class="admin-table">
            <thead>
              <tr>
                <th>Tipo</th>
                <th>Archivo</th>
                <th>Fecha</th>
                <th>Estado</th>
                <th>Acci√≥n</th>
              </tr>
            </thead>
            <tbody>
              {% for doc in user_docs %}
              <tr>
                <td>{{ doc.type_name }}</td>
                <td><a href__="{{ url_for('uploaded_file', filename=doc.file_path) }}" target="_blank" class="link-accent">Ver Archivo</a></td>
                <td>{{ doc.uploaded_at.strftime('%d/%m/%Y') }}</td>
                <td><span class="status-badge {{ doc.status }}">{{ doc.status }}</span></td>
                <td>
                  <form method="POST" action="{{ url_for('change_document_status', id=doc.id) }}" class="inline-form">
                    <select name="status" required class="admin-select">
                      <option value="pending" {% if doc.status=='pending' %}selected{% endif %}>Revisi√≥n</option>
                      <option value="approved" {% if doc.status=='approved' %}selected{% endif %}>Aprobar</option>
                      <option value="rejected" {% if doc.status=='rejected' %}selected{% endif %}>Rechazar</option>
                    </select>
                    <button type="submit" class="action-btn mini">OK</button>
                  </form>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% else %}
          <p class="empty-msg">Sin documentos subidos.</p>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </section>
  </main>

  <script>
    // ====== NAVEGACI√ìN DEL SIDEBAR ======
    const navItems = document.querySelectorAll('.sidebar-nav .nav-item');
    const sections = document.querySelectorAll('.admin-section');

    navItems.forEach(item => {
      item.addEventListener('click', (e) => {
        e.preventDefault();
        
        // Remover clase active de todos los items
        navItems.forEach(nav => nav.classList.remove('active'));
        
        // Agregar clase active al item clickeado
        item.classList.add('active');
        
        // Obtener la secci√≥n a mostrar
        const targetSection = item.getAttribute('data-section');
        
        // Ocultar todas las secciones
        sections.forEach(section => section.classList.add('hidden'));
        
        // Mostrar solo la secci√≥n target
        const sectionToShow = document.getElementById(targetSection);
        if (sectionToShow) {
          sectionToShow.classList.remove('hidden');
        }
      });
    });

    // ====== TOGGLE DE ACORDEONES ======
    function toggleDocuments(button, id) {
      const content = document.getElementById(id);
      content.classList.toggle('hidden');
      
      // Rotar la flecha
      button.classList.toggle('open');
    }

    // ====== THEME TOGGLE ======
    const themeToggle = document.getElementById('theme-toggle');
    
    // Cargar tema guardado
    const savedTheme = localStorage.getItem('theme') || 'light';
    if (savedTheme === 'dark') {
      document.body.classList.remove('light-mode');
      document.body.classList.add('dark-mode');
      themeToggle.checked = true;
    }

    themeToggle.addEventListener('change', () => {
      if (themeToggle.checked) {
        document.body.classList.remove('light-mode');
        document.body.classList.add('dark-mode');
        localStorage.setItem('theme', 'dark');
      } else {
        document.body.classList.remove('dark-mode');
        document.body.classList.add('light-mode');
        localStorage.setItem('theme', 'light');
      }
    });

    // ====== B√öSQUEDA EN TIEMPO REAL ======
    const searchInput = document.querySelector('.search-bar input');
    if (searchInput) {
      searchInput.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        const tableRows = document.querySelectorAll('.admin-table tbody tr');
        
        tableRows.forEach(row => {
          const text = row.textContent.toLowerCase();
          if (text.includes(searchTerm)) {
            row.style.display = '';
          } else {
            row.style.display = 'none';
          }
        });
      });
    }
  </script>
</body>
</html>